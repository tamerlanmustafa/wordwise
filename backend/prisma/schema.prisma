generator client {
  provider             = "prisma-client-py"
  recursive_type_depth = "5"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int                       @id @default(autoincrement())
  email              String                    @unique(map: "ix_users_email") @db.VarChar
  username           String                    @unique(map: "ix_users_username") @db.VarChar
  passwordHash       String?                   @map("password_hash") @db.VarChar
  languagePreference String?                   @map("language_preference") @db.VarChar
  nativeLanguage     String?                   @default("en") @map("native_language") @db.VarChar(10)
  learningLanguage   String?                   @default("en") @map("learning_language") @db.VarChar(10)
  proficiencyLevel   proficiencylevel?         @map("proficiency_level")
  defaultTab         String?                   @default("movies") @map("default_tab") @db.VarChar(10)
  isActive           Boolean?                  @map("is_active")
  isAdmin            Boolean?                  @map("is_admin")
  createdAt          DateTime?                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime?                 @updatedAt @map("updated_at") @db.Timestamptz(6)
  oauthProvider      oauthprovider             @map("oauth_provider")
  googleId           String?                   @unique(map: "ix_users_google_id") @map("google_id") @db.VarChar
  profilePictureUrl  String?                   @map("profile_picture_url") @db.VarChar
  wordLists          UserWordList[]
  translationHistory UserTranslationHistory[]
  userWords          UserWord[]
  reportsMade        WordReport[]              @relation("ReportedBy")
  reportsReviewed    WordReport[]              @relation("ReviewedBy")

  @@index([id], map: "ix_users_id")
  @@map("users")
}

model Movie {
  id                 Int              @id @default(autoincrement())
  title              String           @db.VarChar
  actualTitle        String?          @map("actual_title") @db.VarChar
  year               Int
  genre              String?          @db.VarChar
  difficultyLevel    difficultylevel? @map("difficulty_level")
  difficultyScore    Int?             @map("difficulty_score")
  cefrDistribution   Json?            @map("cefr_distribution")
  script_text        String?
  wordCount          Int?             @map("word_count")
  description        String?
  poster_url         String?          @db.VarChar
  createdAt          DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime?        @updatedAt @map("updated_at") @db.Timestamptz(6)
  // Relations
  words              Word[]
  movieScripts       MovieScript[]
  aliases            MovieAlias[]
  userWords          UserWord[]
  wordReports        WordReport[]

  @@index([id], map: "ix_movies_id")
  @@index([title], map: "ix_movies_title")
  @@index([difficultyLevel], map: "ix_movies_difficulty")
  @@map("movies")
}

model Book {
  id                 Int              @id @default(autoincrement())
  title              String           @db.VarChar
  author             String?          @db.VarChar
  year               Int?
  description        String?          @db.Text
  coverUrl           String?          @map("cover_url") @db.VarChar
  // External IDs
  gutenbergId        Int?             @unique @map("gutenberg_id")
  openLibraryKey     String?          @map("open_library_key") @db.VarChar
  isbn               String?          @db.VarChar
  // Analysis results
  difficultyLevel    difficultylevel? @map("difficulty_level")
  difficultyScore    Int?             @map("difficulty_score")
  cefrDistribution   Json?            @map("cefr_distribution")
  wordCount          Int?             @map("word_count")
  // Timestamps
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  // Relations
  bookText           BookText?

  @@index([id], map: "ix_books_id")
  @@index([title], map: "ix_books_title")
  @@index([gutenbergId], map: "ix_books_gutenberg_id")
  @@index([difficultyLevel], map: "ix_books_difficulty")
  @@map("books")
}

model BookText {
  id                  Int                       @id @default(autoincrement())
  bookId              Int                       @unique @map("book_id")
  sourceType          booksourcetype            @map("source_type")
  rawText             String?                   @map("raw_text") @db.Text
  cleanedText         String?                   @map("cleaned_text") @db.Text
  cleanedWordCount    Int?                      @map("cleaned_word_count")
  processingMetadata  Json?                     @map("processing_metadata")
  // Original EPUB file content (for reader)
  epubContent         Bytes?                    @map("epub_content")
  // Page extraction info
  totalPages          Int?                      @map("total_pages")
  pageExtractionMethod String?                  @map("page_extraction_method") @db.VarChar(50)
  pageData            Json?                     @map("page_data") // Stores page boundaries
  createdAt           DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime                  @updatedAt @map("updated_at") @db.Timestamptz(6)
  // Relations
  book                Book                      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  wordClassifications BookWordClassification[]

  @@index([bookId], map: "ix_book_texts_book_id")
  @@map("book_texts")
}

model BookWordClassification {
  id            Int               @id @default(autoincrement())
  bookTextId    Int               @map("book_text_id")
  word          String            @db.VarChar
  lemma         String            @db.VarChar
  pos           String?           @db.VarChar
  cefrLevel     proficiencylevel  @map("cefr_level")
  confidence    Float
  source        classificationsource
  frequencyRank Int?              @map("frequency_rank")
  pageNumber    Int?              @map("page_number") // Page where this word first appears
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  bookText      BookText          @relation(fields: [bookTextId], references: [id], onDelete: Cascade)

  @@index([bookTextId], map: "ix_book_word_classifications_book_text_id")
  @@index([lemma], map: "ix_book_word_classifications_lemma")
  @@index([cefrLevel], map: "ix_book_word_classifications_cefr_level")
  @@index([bookTextId, cefrLevel], map: "ix_book_word_classifications_book_cefr")
  @@index([pageNumber], map: "ix_book_word_classifications_page")
  @@map("book_word_classifications")
}

model MovieScript {
  id                  Int                   @id @default(autoincrement())
  movieId             Int                   @map("movie_id")
  sourceUsed          scriptsource          @map("source_used")
  rawSubtitleText     String?               @map("raw_subtitle_text") @db.Text
  cleanedScriptText   String?               @map("cleaned_script_text")
  cleanedWordCount    Int?                  @map("cleaned_word_count")
  tokenizedWords      Json?                 @map("tokenized_words")
  cefrResults         Json?                 @map("cefr_results")
  isPreprocessed      Boolean               @default(false) @map("is_preprocessed")
  isTruncated         Boolean               @default(false) @map("is_truncated")
  isComplete          Boolean               @default(true) @map("is_complete")
  processingMetadata  String?               @map("processing_metadata")
  fetchedAt           DateTime              @default(now()) @map("fetched_at") @db.Timestamptz(6)
  createdAt           DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  movie               Movie                 @relation(fields: [movieId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  wordClassifications WordClassification[]

  @@unique([movieId])
  @@index([movieId], map: "ix_movie_scripts_movie_id")
  @@index([sourceUsed], map: "ix_movie_scripts_source")
  @@map("movie_scripts")
}

model WordClassification {
  id            Int               @id @default(autoincrement())
  scriptId      Int               @map("script_id")
  word          String            @db.VarChar
  lemma         String            @db.VarChar
  pos           String?           @db.VarChar
  cefrLevel     proficiencylevel  @map("cefr_level")
  confidence    Float
  source        classificationsource
  frequencyRank Int?              @map("frequency_rank")
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  script        MovieScript       @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  @@index([scriptId], map: "ix_word_classifications_script_id")
  @@index([lemma], map: "ix_word_classifications_lemma")
  @@index([cefrLevel], map: "ix_word_classifications_cefr_level")
  @@index([scriptId, cefrLevel], map: "ix_word_classifications_script_cefr")
  @@map("word_classifications")
}

model Word {
  id               Int              @id @default(autoincrement())
  word             String           @db.VarChar
  definition       String?
  difficulty_level difficultylevel?
  frequency        Float?
  part_of_speech   String?          @db.VarChar
  example_sentence String?
  translation      String?          @db.VarChar
  movieId          Int?             @map("movie_id")
  userWordLists    UserWordList[]
  movie            Movie?           @relation(fields: [movieId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([id], map: "ix_words_id")
  @@index([word], map: "ix_words_word")
  @@map("words")
}

model UserWordList {
  id       Int       @id @default(autoincrement())
  userId   Int       @map("user_id")
  wordId   Int       @map("word_id")
  listType listtype  @map("list_type")
  added_at DateTime? @default(now()) @db.Timestamptz(6)
  user     User      @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  word     Word      @relation(fields: [wordId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([id], map: "ix_user_word_lists_id")
  @@map("user_word_lists")
}

model alembic_version {
  version_num String @id(map: "alembic_version_pkc") @db.VarChar(32)
}

model ScriptSourcePriority {
  id       Int          @id @default(autoincrement())
  source   scriptsource @unique
  priority Int

  @@index([priority], map: "ix_script_source_priority_priority")
  @@map("script_source_priorities")
}

model MovieAlias {
  id      Int    @id @default(autoincrement())
  movieId Int    @map("movie_id")
  alias   String @db.VarChar
  movie   Movie  @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@index([movieId], map: "ix_movie_aliases_movie_id")
  @@index([alias], map: "ix_movie_aliases_alias")
  @@map("movie_aliases")
}

model TranslationCache {
  id         Int      @id @default(autoincrement())
  sourceText String   @map("source_text") @db.VarChar
  sourceLang String?  @map("source_lang") @db.VarChar(10)
  targetLang String   @map("target_lang") @db.VarChar(10)
  translated String   @db.VarChar
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([sourceText, targetLang], map: "unique_translation")
  @@index([sourceText], map: "ix_translation_cache_source_text")
  @@index([targetLang], map: "ix_translation_cache_target_lang")
  @@map("translation_cache")
}

model UserTranslationHistory {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  word            String   @db.VarChar
  targetLang      String   @map("target_lang") @db.VarChar(10)
  translationUsed String   @map("translation_used") @db.VarChar
  provider        String?  @db.VarChar(20)
  translatedAt    DateTime @default(now()) @map("translated_at") @db.Timestamptz(6)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "ix_user_translation_history_user_id")
  @@index([userId, word], map: "ix_user_translation_history_user_word")
  @@index([userId, translatedAt], map: "ix_user_translation_history_user_date")
  @@map("user_translation_history")
}

model UserWord {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  word      String   @db.VarChar
  movieId   Int?     @map("movie_id")
  isLearned Boolean  @default(false) @map("is_learned")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie     Movie?   @relation(fields: [movieId], references: [id], onDelete: SetNull)

  @@unique([userId, word, movieId], map: "unique_user_word_movie")
  @@index([userId], map: "ix_user_words_user_id")
  @@index([userId, isLearned], map: "ix_user_words_user_learned")
  @@map("user_words")
}

model WordSentenceExample {
  id           Int              @id @default(autoincrement())
  movieId      Int              @map("movie_id")
  word         String           @db.VarChar
  lemma        String           @db.VarChar
  cefrLevel    proficiencylevel @map("cefr_level")
  sentence     String           @db.Text
  translation  String           @db.Text
  targetLang   String           @map("target_lang") @db.VarChar(10)
  wordPosition Int              @map("word_position")
  createdAt    DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([movieId, word, sentence, targetLang], map: "unique_word_sentence_example")
  @@index([movieId], map: "ix_word_sentence_examples_movie_id")
  @@index([movieId, word], map: "ix_word_sentence_examples_movie_word")
  @@index([movieId, targetLang], map: "ix_word_sentence_examples_movie_lang")
  @@map("word_sentence_examples")
}

enum difficultylevel {
  BEGINNER
  ELEMENTARY
  INTERMEDIATE
  UPPER_INTERMEDIATE
  ADVANCED
  PROFICIENT
}

enum listtype {
  LEARN_LATER
  FAVORITES
  MASTERED
}

enum booksourcetype {
  GUTENBERG
  MANUAL_UPLOAD
  OPEN_LIBRARY
}

enum oauthprovider {
  email
  google
  facebook
}

enum proficiencylevel {
  A1
  A2
  B1
  B2
  C1
  C2
}

enum scriptsource {
  STANDS4_PDF
  STANDS4_API
  SUBTITLE_SRT
  SUBTITLE_VTT
  SYNOPSIS
  MANUAL_UPLOAD
}

enum classificationsource {
  oxford_3000
  oxford_5000
  efllex
  evp
  frequency_backoff
  embedding_classifier
  fallback
}

enum reportreason {
  WRONG_TRANSLATION
  WRONG_CONTEXT
  WRONG_SPELLING
  INAPPROPRIATE_CONTENT
  OTHER
}

enum reportstatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

model WordReport {
  id                Int          @id @default(autoincrement())
  word              String       @db.VarChar
  movieId           Int?         @map("movie_id")
  movieTitle        String?      @map("movie_title") @db.VarChar
  reason            reportreason
  details           String?      @db.Text
  translationSource String?      @map("translation_source") @db.VarChar
  status            reportstatus @default(PENDING)
  reporterId        Int          @map("reporter_id")
  reviewerId        Int?         @map("reviewer_id")
  reviewNotes       String?      @map("review_notes") @db.Text
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  reporter    User         @relation("ReportedBy", fields: [reporterId], references: [id], onDelete: Cascade)
  reviewer    User?        @relation("ReviewedBy", fields: [reviewerId], references: [id], onDelete: SetNull)
  movie       Movie?       @relation(fields: [movieId], references: [id], onDelete: SetNull)

  @@index([status], map: "ix_word_reports_status")
  @@index([word], map: "ix_word_reports_word")
  @@index([reporterId], map: "ix_word_reports_reporter")
  @@map("word_reports")
}
